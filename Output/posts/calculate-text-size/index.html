<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="https://unpkg.com/purecss@1.0.1/build/pure-min.css" integrity="sha384-oAOxQR6DkCoMliIh8yFnu25d7Eq/PHS21PClpwjOTeU2jRSq11vu66rf90/cZr47" crossorigin="anonymous"/><link rel="stylesheet" href="https://unpkg.com/purecss@1.0.1/build/grids-responsive-min.css"/><link rel="stylesheet" href="/Pure/styles.css"/><link rel="stylesheet" href="/all.css"/></head><body><div id="layout" class="pure-g"><div class="sidebar pure-u-1 pure-u-md-1-4"><div class="header"><div id="layout" class="pure-g"><div class="pure-u-md-1-1 pure-u-3-4"><h1 class="brand-title">Bitomule's learning shack</h1><h3 class="brand-tagline">My thoughts about iOS, technology or any other thing that comes to my mind.</h3></div></div><div id="layout" class="pure-g"><div class="pure-u-md-1-1"><a href="mailto:bitomule+blog@gmail.com"><i class="fas fa-envelope-open-text l-box social-icon"></i><a class="social-media" href="mailto:bitomule+blog@gmail.com">Email</a></a></div><div class="pure-u-md-1-1"><a href="https://www.linkedin.com/in/davidcolladosela/"><i class="fab fa-linkedin l-box social-icon"></i><a class="social-media" href="https://www.linkedin.com/in/davidcolladosela/">LinkedIn</a></a></div><div class="pure-u-md-1-1"><a href="https://github.com/bitomule"><i class="fab fa-github-square l-box social-icon"></i><a class="social-media" href="https://github.com/bitomule">GitHub</a></a></div><div class="pure-u-md-1-1"><a href="https://twitter.com/Bitomule"><i class="fab fa-twitter-square l-box social-icon"></i><a class="social-media" href="https://twitter.com/Bitomule">Twitter</a></a></div></div></div></div><div class="content pure-u-1 pure-u-md-3-5 pure-u-xl-6-10"><h2 class="post-title"><a href="/posts/calculate-text-size">Getting text size on iOS</a></h2><p class="post-meta">April 3, 2016</p><div class="post-tags"><a class="post-category post-category-ios" href="/tags/ios">iOS</a></div><div class="post-description"><div><h1>Getting text size on iOS</h1><p>I'm currently working on an iPhone app that uses a 3rd party chat software and adding some custom message types to it requires that collection cell height is precalculated. I don't remember all the iOS APIs on my head but a quick search on google just showed a UIFont extension that calculates a text box (UILabel or TextView) size. It was something like:</p><pre><code>		<span class="keyword">extension</span> <span class="type">UIFont</span> {
	<span class="keyword">func</span> sizeOfString (string: <span class="type">String</span>, constrainedToWidth width: <span class="type">Double</span>) -&gt; <span class="type">CGSize</span> {
	<span class="keyword">return</span> <span class="type">NSString</span>(string: string).<span class="call">boundingRectWithSize</span>(<span class="type">CGSize</span>(width: width, height: <span class="type">DBL_MAX</span>),
	options: <span class="type">NSStringDrawingOptions</span>.<span class="type">UsesLineFragmentOrigin</span>,
	attributes: [<span class="type">NSFontAttributeName</span>: <span class="keyword">self</span>],
	context: <span class="keyword">nil</span>).<span class="property">size</span>
	}
	}
</code></pre><p>It was easy and fast. I also needed it in another place to get width with a defined height so I changed it to allow it and done! Just using a font reference I can get the size of a text box. I added some tests just to be sure that it returns the same size I get in interface builder for my view (including margins and other views) and it worked perfect.</p><p>I continued developing other parts of the app but after a few days I saw a weird bug, one of us sent a message with a whole line composed only from emoji characters and then height calculation failed, that whole line was removed from view, my quick and easy method to calculate height was ignoring emoji. WTF!!</p><p>Back to google, searching for a bug report or something that could tell me why something so simple didn't work with emoji. I found some posts asking the same and one pointing on a direction I already know, using UILabel sizeToFit method. Ok, creating a UILabel each time I need a cell height isn't perfect but this collection view caches heights so it's something I can live with. Changed my method to use sizeToFit instead of boundingRectWithSize and... FAIL</p><p>Using sizeToFit returned the same size as boundingRectWithSize, I can't believe that both methods ignored emoji. That was a moment to stop and think: "there should be a way to do this but maybe not so easy". That made me start searching not so easy ways of getting text size in iOS. My first search was related to CoreText and I got a result that pointed me in the right direction: CTFramesetter</p><p>It was something I've never used but the only option I had so I went to official API docs and changed again my extension method to use it. The result? It worked!!</p><p>I'm not sure how fast it is but fixed the big issue I had. If you find the same issue hope you find this post and can just copy paste this code to your app:</p><pre><code>		<span class="keyword">func</span> sizeOfString (string: <span class="type">String</span>, constrainedToWidth width: <span class="type">Double</span>) -&gt; <span class="type">CGSize</span> {
	<span class="keyword">let</span> attributes = [<span class="type">NSFontAttributeName</span>:<span class="keyword">self</span>,]
	<span class="keyword">let</span> attString = <span class="type">NSAttributedString</span>(string: string,attributes: attributes)
	<span class="keyword">let</span> framesetter = <span class="type">CTFramesetterCreateWithAttributedString</span>(attString)
	<span class="keyword">return</span> <span class="type">CTFramesetterSuggestFrameSizeWithConstraints</span>(framesetter, <span class="type">CFRange</span>(location: <span class="number">0</span>,length: <span class="number">0</span>), <span class="keyword">nil</span>, <span class="type">CGSize</span>(width: width, height: <span class="type">DBL_MAX</span>), <span class="keyword">nil</span>)
	}
</code></pre></div></div></div><div class="footer pure-u-1"><div class="pure-u-1">Â© 2020 Bitomule's learning shack</div><div class="pure-u-1">Generated using <a href="https://github.com/johnsundell/publish">Publish</a>. Written in Swift</div><div class="pure-u-1"><a href="/feed.rss">RSS feed</a></div></div></div></body></html>